<header class="hero card border-0 shadow-lg text-white mb-4">
  <div class="card-body py-5">
    <div class="row align-items-center">
      <div class="col-12 col-lg-8">
        <h1 class="hero__title mb-3">Sistema de Gestión Interna</h1>
        <p class="hero__subtitle mb-0 fs-5">Productos de Maquinarias de Romero</p>
        <p class="mt-2 mb-0 opacity-75">Bienvenido, <strong>{{usuario.nombre}}</strong></p>
      </div>
      <div class="col-12 col-lg-4 text-center text-lg-end mt-3 mt-lg-0">
        <span class="badge bg-warning text-dark fs-6 px-4 py-2">{{usuario.rol}}</span>
      </div>
    </div>
  </div>
</header>

<section class="row g-4 mb-4">
  <!-- Tarjeta: Total Productos -->
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body text-center">
        <div class="mb-3">
          <i class="bi bi-box-seam fs-1 text-primary"></i>
        </div>
        <h3 class="h2 text-primary mb-2">{{formatNumber stats.totalProductos}}</h3>
        <p class="text-muted mb-0 fw-semibold">Total Productos</p>
      </div>
    </div>
  </div>

  <!-- Tarjeta: Stock Crítico -->
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card border-0 shadow-sm h-100 border-danger border-2">
      <div class="card-body text-center">
        <div class="mb-3">
          <i class="bi bi-exclamation-triangle fs-1 text-danger"></i>
        </div>
        <h3 class="h2 text-danger mb-2">{{formatNumber stats.productosCriticos}}</h3>
        <p class="text-muted mb-0 fw-semibold">Stock Crítico (≤4)</p>
      </div>
    </div>
  </div>

  <!-- Tarjeta: Bajo Stock -->
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card border-0 shadow-sm h-100 border-warning border-2">
      <div class="card-body text-center">
        <div class="mb-3">
          <i class="bi bi-exclamation-circle fs-1 text-warning"></i>
        </div>
        <h3 class="h2 text-warning mb-2">{{formatNumber stats.productosBajoStock}}</h3>
        <p class="text-muted mb-0 fw-semibold">Bajo Stock (&lt;10)</p>
      </div>
    </div>
  </div>

  <!-- Tarjeta: Movimientos del Mes -->
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body text-center">
        <div class="mb-3">
          <i class="bi bi-arrow-left-right fs-1 text-info"></i>
        </div>
        <h3 class="h5 text-info mb-2">
          <span class="text-success">↑ {{formatNumber stats.ingresosMes}}</span> /
          <span class="text-danger">↓ {{formatNumber stats.egresosMes}}</span>
        </h3>
        <p class="text-muted mb-0 fw-semibold">Movimientos (Mes)</p>
      </div>
    </div>
  </div>
</section>

<div class="row g-4 mb-4">
  <!-- Gráfico de Distribución -->
  <div class="col-12 col-lg-8">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-white py-3">
        <h5 class="mb-0 fw-bold text-primary">
          <i class="bi bi-pie-chart-fill me-2"></i>
          Distribución de Inventario
        </h5>
      </div>
      <div class="card-body">
        <canvas id="productosChart" style="max-height: 300px;"></canvas>
      </div>
    </div>
  </div>

  <!-- Resumen Rápido -->
  <div class="col-12 col-lg-4">
    <div class="card border-0 shadow-sm h-100 bg-primary text-white">
      <div class="card-body p-4 d-flex flex-column justify-content-center text-center">
        <h4 class="mb-4 opacity-75">Estado del Sistema</h4>
        <div class="display-1 fw-bold mb-2">{{formatNumber stats.totalProductos}}</div>
        <p class="fs-5 mb-4">Productos Totales</p>
        <hr class="border-white opacity-25 my-4">
        <div class="row">
          <div class="col-6 border-end border-white border-opacity-25">
            <div class="h3 mb-0">{{formatNumber stats.ingresosMes}}</div>
            <small class="opacity-75">Ingresos (Mes)</small>
          </div>
          <div class="col-6">
            <div class="h3 mb-0">{{formatNumber stats.egresosMes}}</div>
            <small class="opacity-75">Egresos (Mes)</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mb-4">
  <!-- Productos con Stock Crítico -->
  <div class="col-12 col-lg-6">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-danger text-white">
        <h5 class="mb-0 fw-bold">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          Productos con Stock Crítico
        </h5>
      </div>
      <div class="card-body p-0">
        {{#if productosCriticosLista.length}}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Referencia</th>
                <th>Descripción</th>
                <th class="text-end">Stock</th>
              </tr>
            </thead>
            <tbody>
              {{#each productosCriticosLista}}
              <tr class="{{#if (lte this.existencia 4)}}table-danger{{/if}}">
                <td class="fw-semibold">{{this.referencia}}</td>
                <td>{{this.nombre}}</td>
                <td class="text-end fw-bold text-danger">{{formatNumber this.existencia}}</td>
              </tr>
              {{/each}}
            </tbody>
          </table>
        </div>
        {{else}}
        <div class="text-center py-4 text-muted">
          <i class="bi bi-check-circle fs-1 d-block mb-2 text-success"></i>
          <p class="mb-0">No hay productos con stock crítico</p>
        </div>
        {{/if}}
      </div>
      <div class="card-footer bg-light">
        <a href="/inventario" class="btn btn-sm btn-primary">
          Ver Inventario Completo
        </a>
      </div>
    </div>
  </div>

  <!-- Movimientos Recientes -->
  <div class="col-12 col-lg-6">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0 fw-bold">
          <i class="bi bi-clock-history me-2"></i>
          Movimientos Recientes
        </h5>
      </div>
      <div class="card-body p-0">
        {{#if movimientosRecientes.length}}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Fecha</th>
                <th>Referencia</th>
                <th>Tipo</th>
                <th class="text-end">Cantidad</th>
              </tr>
            </thead>
            <tbody>
              {{#each movimientosRecientes}}
              <tr>
                <td class="small">{{formatDate this.createdAt}}</td>
                <td class="fw-semibold">{{this.referencia}}</td>
                <td>
                  <span
                    class="badge {{#if (eq this.tipo 'ingreso')}}bg-success{{else}}bg-danger{{/if}} text-capitalize">
                    {{this.tipo}}
                  </span>
                </td>
                <td class="text-end">{{formatNumber this.cantidad}}</td>
              </tr>
              {{/each}}
            </tbody>
          </table>
        </div>
        {{else}}
        <div class="text-center py-4 text-muted">
          <i class="bi bi-inbox fs-1 d-block mb-2"></i>
          <p class="mb-0">No hay movimientos registrados</p>
        </div>
        {{/if}}
      </div>
      <div class="card-footer bg-light">
        <a href="/movimientos" class="btn btn-sm btn-primary">
          Ver Todos los Movimientos
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Accesos Rápidos -->
<div class="row g-4">
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0 fw-bold">
          <i class="bi bi-lightning-charge-fill me-2"></i>
          Accesos Rápidos
        </h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-12 col-md-6 col-lg-3">
            <a href="/inventario" class="btn btn-outline-primary w-100 py-3">
              <i class="bi bi-box-seam fs-3 d-block mb-2"></i>
              <span class="fw-semibold">Ver Inventario</span>
            </a>
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <a href="/movimientos" class="btn btn-outline-success w-100 py-3">
              <i class="bi bi-list-check fs-3 d-block mb-2"></i>
              <span class="fw-semibold">Ver Movimientos</span>
            </a>
          </div>
          {{#if (eq usuario.rol 'administrador')}}
          <div class="col-12 col-md-6 col-lg-3">
            <a href="/auth/register" class="btn btn-outline-warning w-100 py-3">
              <i class="bi bi-person-plus fs-3 d-block mb-2"></i>
              <span class="fw-semibold">Crear Usuario</span>
            </a>
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <a href="/movimientos/descargar" class="btn btn-outline-info w-100 py-3">
              <i class="bi bi-download fs-3 d-block mb-2"></i>
              <span class="fw-semibold">Descargar Excel</span>
            </a>
          </div>
          {{/if}}
        </div>
      </div>
    </div>
  </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const ctx = document.getElementById('productosChart');
    if (ctx) {
      // Datos pasados desde el backend con el helper json correctamente cerrado
      const tiposData = {{{ json stats.tiposContador }}};
      
      const labels = Object.keys(tiposData);
      const data = Object.values(tiposData);

      // Colores para el gráfico
      const backgroundColors = [
        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
        '#858796', '#5a5c69', '#f8f9fc', '#4e73df', '#1cc88a'
      ];

      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: backgroundColors,
            hoverBackgroundColor: backgroundColors,
            hoverBorderColor: "rgba(234, 236, 244, 1)",
          }],
        },
        options: {
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                font: {
                  family: "'Nunito', sans-serif",
                  size: 12
                },
                usePointStyle: true
              }
            }
          },
          layout: {
            padding: {
              left: 10,
              right: 10,
              top: 10,
              bottom: 10
            }
          }
        }
      });
    }
  });
</script>