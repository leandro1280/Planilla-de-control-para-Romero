<header class="hero card border-0 shadow-lg text-white mb-4">
  <div class="card-body py-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div>
        <h1 class="hero__title mb-2">
          <i class="bi bi-people me-2"></i>Gesti√≥n de Usuarios
        </h1>
        <p class="hero__subtitle mb-0">Administra los usuarios del sistema</p>
      </div>
      <a href="/auth/register" class="btn btn-light btn-lg">
        <i class="bi bi-person-plus me-2"></i>Nuevo Usuario
      </a>
    </div>
  </div>
</header>

<section class="card border-0 shadow-sm">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0 fw-bold">
      <i class="bi bi-list-ul me-2"></i>
      Lista de Usuarios ({{usuarios.length}})
    </h5>
  </div>
  <div class="card-body p-0">
    {{#if usuarios.length}}
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Nombre</th>
            <th>Email</th>
            <th>Rol</th>
            <th>Estado</th>
            <th>Creado por</th>
            <th>Fecha creaci√≥n</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {{#each usuarios}}
          <tr class="{{#unless this.activo}}table-secondary opacity-75{{/unless}}">
            <td class="fw-semibold">
              {{this.nombre}}
              {{#if (eq (toString this._id) (toString ../usuario._id))}}
              <span class="badge bg-info ms-2">T√∫</span>
              {{/if}}
            </td>
            <td>
              <small>{{this.email}}</small>
            </td>
            <td>
              <span class="badge 
                {{#if (eq this.rol 'administrador')}}bg-danger
                {{else if (eq this.rol 'supervisor')}}bg-primary
                {{else}}bg-secondary{{/if}} text-capitalize">
                {{this.rol}}
              </span>
            </td>
            <td>
              {{#if this.activo}}
              <span class="badge bg-success">
                <i class="bi bi-check-circle me-1"></i>Activo
              </span>
              {{else}}
              <span class="badge bg-secondary">
                <i class="bi bi-x-circle me-1"></i>Inactivo
              </span>
              {{/if}}
              {{#if this.passwordResetRequired}}
              <span class="badge bg-warning text-dark ms-2" title="El usuario debe cambiar su contrase√±a">
                <i class="bi bi-key me-1"></i>Cambiar contrase√±a
              </span>
              {{/if}}
            </td>
            <td>
              {{#if this.creadoPor}}
              <small>{{this.creadoPor.nombre}}</small>
              {{else}}
              <small class="text-muted">-</small>
              {{/if}}
            </td>
            <td>
              <small class="text-muted">{{formatDate this.createdAt}}</small>
            </td>
            <td class="text-end">
              <div class="btn-group" role="group">
                {{#unless (eq (toString this._id) (toString ../usuario._id))}}
                <button 
                  class="btn btn-sm {{#if this.activo}}btn-warning{{else}}btn-success{{/if}} btn-toggle-activo" 
                  data-id="{{this._id}}"
                  data-activo="{{this.activo}}"
                  title="{{#if this.activo}}Desactivar{{else}}Activar{{/if}} usuario">
                  <i class="bi {{#if this.activo}}bi-toggle-on{{else}}bi-toggle-off{{/if}}"></i>
                </button>
                {{/unless}}
                {{#unless (eq (toString this._id) (toString ../usuario._id))}}
                {{#if (or (eq this.rol 'supervisor') (eq this.rol 'operario'))}}
                <button 
                  class="btn btn-sm btn-info btn-reset-password" 
                  data-id="{{this._id}}"
                  data-nombre="{{this.nombre}}"
                  data-email="{{this.email}}"
                  title="Resetear contrase√±a">
                  <i class="bi bi-key"></i>
                </button>
                {{/if}}
                {{/unless}}
                {{#if (eq this.rol 'administrador')}}
                <span class="badge bg-dark ms-2" title="No se puede eliminar un administrador">
                  <i class="bi bi-shield-fill"></i>
                </span>
                {{else}}
                {{#unless (eq (toString this._id) (toString ../usuario._id))}}
                <button 
                  class="btn btn-sm btn-danger btn-eliminar-usuario" 
                  data-id="{{this._id}}"
                  data-nombre="{{this.nombre}}"
                  data-email="{{this.email}}"
                  title="Eliminar usuario">
                  <i class="bi bi-trash"></i>
                </button>
                {{/unless}}
                {{/if}}
              </div>
            </td>
          </tr>
          {{/each}}
        </tbody>
      </table>
    </div>
    {{else}}
    <div class="text-center py-5 text-muted">
      <i class="bi bi-people fs-1 d-block mb-3"></i>
      <p class="mb-0">No hay usuarios registrados</p>
      <a href="/auth/register" class="btn btn-primary mt-3">
        <i class="bi bi-person-plus me-2"></i>Crear primer usuario
      </a>
    </div>
    {{/if}}
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Toggle activo/inactivo
  const botonesToggle = document.querySelectorAll('.btn-toggle-activo');
  botonesToggle.forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.dataset.id;
      const activoActual = this.dataset.activo === 'true';
      const accion = activoActual ? 'desactivar' : 'activar';
      
      if (confirm(`¬øEst√°s seguro de ${accion} este usuario?`)) {
        toggleUsuario(id, !activoActual);
      }
    });
  });

  // Resetear contrase√±a
  const botonesResetPassword = document.querySelectorAll('.btn-reset-password');
  botonesResetPassword.forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.dataset.id;
      const nombre = this.dataset.nombre;
      const email = this.dataset.email;
      
      const confirmacion = confirm(
        `üîë ¬øRESETEAR CONTRASE√ëA?\n\n` +
        `Usuario: ${nombre}\n` +
        `Email: ${email}\n\n` +
        `Se generar√° una nueva contrase√±a temporal.\n` +
        `La contrase√±a se mostrar√° UNA SOLA VEZ.\n\n` +
        `¬øContinuar?`
      );
      
      if (confirmacion) {
        resetPassword(id, nombre, email);
      }
    });
  });

  // Eliminar usuario
  const botonesEliminar = document.querySelectorAll('.btn-eliminar-usuario');
  botonesEliminar.forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.dataset.id;
      const nombre = this.dataset.nombre;
      const email = this.dataset.email;
      
      const confirmacion = confirm(
        `‚ö†Ô∏è ¬øELIMINAR USUARIO?\n\n` +
        `Nombre: ${nombre}\n` +
        `Email: ${email}\n\n` +
        `Esta acci√≥n NO se puede deshacer.\n` +
        `El usuario no podr√° acceder al sistema.\n\n` +
        `¬øEst√°s seguro de continuar?`
      );
      
      if (confirmacion) {
        eliminarUsuario(id);
      }
    });
  });

  async function toggleUsuario(id, activo) {
    try {
      const response = await fetch(`/auth/usuarios/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ activo })
      });

      const result = await response.json();

      if (result.success) {
        alert(`Usuario ${activo ? 'activado' : 'desactivado'} correctamente`);
        window.location.reload();
      } else {
        alert(result.message || 'Error al actualizar el usuario');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error de conexi√≥n');
    }
  }

  async function resetPassword(id, nombre, email) {
    try {
      const response = await fetch(`/auth/usuarios/${id}/reset-password`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      });

      const result = await response.json();

      if (result.success) {
        // Mostrar la contrase√±a temporal en un modal o alerta
        const mensaje = 
          `‚úÖ CONTRASE√ëA RESETEADA\n\n` +
          `Usuario: ${nombre}\n` +
          `Email: ${email}\n\n` +
          `üîë NUEVA CONTRASE√ëA TEMPORAL:\n` +
          `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
          `${result.tempPassword}\n` +
          `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
          `‚ö†Ô∏è IMPORTANTE:\n` +
          `‚Ä¢ Esta contrase√±a se muestra UNA SOLA VEZ\n` +
          `‚Ä¢ Comp√°rtela con el usuario de forma segura\n` +
          `‚Ä¢ El usuario deber√° cambiarla en su primer inicio de sesi√≥n\n\n` +
          `¬øCopiar contrase√±a al portapapeles?`;
        
        if (confirm(mensaje)) {
          // Copiar al portapapeles
          navigator.clipboard.writeText(result.tempPassword).then(() => {
            alert('‚úÖ Contrase√±a copiada al portapapeles');
          }).catch(() => {
            alert('‚ö†Ô∏è No se pudo copiar autom√°ticamente. Por favor, copia manualmente.');
          });
        }
        
        // Recargar la p√°gina despu√©s de un momento
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      } else {
        alert(result.message || 'Error al resetear la contrase√±a');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error de conexi√≥n');
    }
  }

  async function eliminarUsuario(id) {
    try {
      const response = await fetch(`/auth/usuarios/${id}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        }
      });

      const result = await response.json();

      if (result.success) {
        alert('Usuario eliminado correctamente');
        window.location.reload();
      } else {
        alert(result.message || 'Error al eliminar el usuario');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error de conexi√≥n');
    }
  }
});
</script>

