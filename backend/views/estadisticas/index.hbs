<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="mb-0">
        <i class="bi bi-graph-up me-2"></i>Estadísticas Avanzadas
      </h2>
      <p class="text-muted">Análisis detallado de consumo, tendencias y predicciones</p>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Filtros</h5>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Período</label>
          <select id="filtro-periodo" class="form-select">
            <option value="semana">Última semana</option>
            <option value="mes" selected>Último mes</option>
            <option value="trimestre">Último trimestre</option>
            <option value="año">Último año</option>
            <option value="personalizado">Personalizado</option>
          </select>
        </div>
        <div class="col-md-3" id="fecha-desde-container" style="display: none;">
          <label class="form-label">Desde</label>
          <input type="date" id="fecha-desde" class="form-control">
        </div>
        <div class="col-md-3" id="fecha-hasta-container" style="display: none;">
          <label class="form-label">Hasta</label>
          <input type="date" id="fecha-hasta" class="form-control">
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button class="btn btn-primary w-100" id="btn-aplicar-filtros">
            <i class="bi bi-search me-1"></i>Aplicar Filtros
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenedor de estadísticas -->
  <div id="estadisticas-container">
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const filtroPeriodo = document.getElementById('filtro-periodo');
  const fechaDesdeContainer = document.getElementById('fecha-desde-container');
  const fechaHastaContainer = document.getElementById('fecha-hasta-container');
  const btnAplicar = document.getElementById('btn-aplicar-filtros');
  
  filtroPeriodo.addEventListener('change', function() {
    if (this.value === 'personalizado') {
      fechaDesdeContainer.style.display = 'block';
      fechaHastaContainer.style.display = 'block';
    } else {
      fechaDesdeContainer.style.display = 'none';
      fechaHastaContainer.style.display = 'none';
    }
  });

  function cargarEstadisticas() {
    const periodo = filtroPeriodo.value;
    const fechaDesde = document.getElementById('fecha-desde').value;
    const fechaHasta = document.getElementById('fecha-hasta').value;
    
    let url = `/api/estadisticas/avanzadas?periodo=${periodo}`;
    if (fechaDesde && fechaHasta) {
      url += `&fechaDesde=${fechaDesde}&fechaHasta=${fechaHasta}`;
    }

    fetch(url)
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          mostrarEstadisticas(data.data);
        } else {
          mostrarError('Error al cargar estadísticas');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        mostrarError('Error al cargar estadísticas');
      });
  }

  function mostrarEstadisticas(data) {
    const container = document.getElementById('estadisticas-container');
    
    // Productos más movidos
    let productosMasMovidosHTML = '';
    if (data.productosMasMovidos && data.productosMasMovidos.length > 0) {
      productosMasMovidosHTML = `
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-trophy me-2"></i>Top 10 Productos Más Movidos</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Referencia</th>
                    <th>Nombre</th>
                    <th>Tipo</th>
                    <th class="text-end">Cantidad Total</th>
                    <th class="text-end">Valor Total</th>
                    <th class="text-end">Movimientos</th>
                  </tr>
                </thead>
                <tbody>
                  ${data.productosMasMovidos.map((prod, index) => `
                    <tr>
                      <td><strong>${index + 1}</strong></td>
                      <td>${prod.referencia}</td>
                      <td>${prod.nombre}</td>
                      <td><span class="badge bg-secondary">${prod.tipo}</span></td>
                      <td class="text-end">${prod.cantidadTotal.toLocaleString()}</td>
                      <td class="text-end">$${prod.valorTotal.toLocaleString('es-AR', {minimumFractionDigits: 2})}</td>
                      <td class="text-end">${prod.movimientos}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    // Análisis de costos
    const analisisCostosHTML = `
      <div class="row g-4 mb-4">
        <div class="col-md-3">
          <div class="card border-success">
            <div class="card-body text-center">
              <h3 class="text-success">$${data.analisisCostos.inversionTotal.toLocaleString('es-AR', {minimumFractionDigits: 2})}</h3>
              <p class="mb-0">Inversión Total</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card border-danger">
            <div class="card-body text-center">
              <h3 class="text-danger">$${data.analisisCostos.consumoTotal.toLocaleString('es-AR', {minimumFractionDigits: 2})}</h3>
              <p class="mb-0">Consumo Total</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card border-${data.analisisCostos.balance >= 0 ? 'info' : 'warning'}">
            <div class="card-body text-center">
              <h3 class="text-${data.analisisCostos.balance >= 0 ? 'info' : 'warning'}">$${data.analisisCostos.balance.toLocaleString('es-AR', {minimumFractionDigits: 2})}</h3>
              <p class="mb-0">Balance</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card border-primary">
            <div class="card-body text-center">
              <h3 class="text-primary">${data.analisisCostos.unidadesIngresadas.toLocaleString()}</h3>
              <p class="mb-0">Unidades Ingresadas</p>
            </div>
          </div>
        </div>
      </div>
    `;

    // Gráfico de tendencia mensual
    let graficoTendenciaHTML = '';
    if (data.analisisMensual && data.analisisMensual.length > 0) {
      const meses = data.analisisMensual.map(m => m.mes);
      const ingresos = data.analisisMensual.map(m => m.ingresos);
      const egresos = data.analisisMensual.map(m => m.egresos);
      
      graficoTendenciaHTML = `
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Tendencia Mensual</h5>
          </div>
          <div class="card-body">
            <canvas id="graficoTendencia" height="60"></canvas>
          </div>
        </div>
      `;
      
      setTimeout(() => {
        const ctx = document.getElementById('graficoTendencia');
        if (ctx) {
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: meses,
              datasets: [{
                label: 'Ingresos',
                data: ingresos,
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4
              }, {
                label: 'Egresos',
                data: egresos,
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: 'top' }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        }
      }, 100);
    }

    container.innerHTML = `
      ${analisisCostosHTML}
      ${graficoTendenciaHTML}
      ${productosMasMovidosHTML}
    `;
  }

  function mostrarError(mensaje) {
    document.getElementById('estadisticas-container').innerHTML = `
      <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle me-2"></i>${mensaje}
      </div>
    `;
  }

  btnAplicar.addEventListener('click', cargarEstadisticas);
  cargarEstadisticas(); // Cargar al iniciar
});
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

