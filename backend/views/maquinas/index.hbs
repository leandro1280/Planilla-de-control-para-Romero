<header class="hero card border-0 shadow-lg text-white mb-4 bg-primary">
  <div class="card-body p-4 p-lg-5">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-center gap-3">
      <div class="text-center text-lg-start">
        <h1 class="hero__title fw-bold mb-2">
          <i class="bi bi-gear me-2"></i>Gestión de Máquinas
        </h1>
        <p class="hero__subtitle mb-0 opacity-75 fs-5">Administra máquinas, repuestos y mantenimientos</p>
      </div>
      <div class="d-flex flex-wrap justify-content-center gap-2 hero__meta text-nowrap">
        {{#if (or (eq usuario.rol 'administrador') (eq usuario.rol 'supervisor'))}}
        <a href="/maquinas/nueva" class="btn btn-light text-primary px-3 fw-semibold">
          <i class="bi bi-plus-circle me-1"></i>Nueva Máquina
        </a>
        {{/if}}
        <button type="button" class="btn btn-outline-light px-3" id="btn-qr-universal">
          <i class="bi bi-qr-code-scan me-1"></i>Escanear QR
        </button>
      </div>
    </div>
  </div>
</header>

<section class="panel card border-0 shadow-sm mb-4">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-12 col-md-6 col-lg-4">
        <label class="form-label fw-semibold text-primary">Buscar</label>
        <input id="buscador" type="search" class="form-control form-control-lg"
          placeholder="Código, nombre, ubicación..." autocomplete="off" value="{{busqueda}}">
      </div>
    </div>
  </div>
</section>

<section class="panel card border-0 shadow-sm mb-4">
  <div class="card-body">
    <h2 class="panel-title mb-4">Lista de Máquinas ({{totalMaquinas}})</h2>
    <div class="table-responsive">
      <table id="tabla-maquinas" class="table table-hover mb-0">
        <thead class="table-primary">
          <tr>
            <th>Código</th>
            <th>Nombre</th>
            <th>Ubicación</th>
            <th>Marca/Modelo</th>
            <th>Repuestos</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {{#if maquinas}}
          {{#if (gt maquinas.length 0)}}
          {{#each maquinas}}
          <tr>
            <td class="fw-semibold">
              <span class="badge bg-primary">{{this.codigo}}</span>
            </td>
            <td>
              <div class="fw-semibold">{{this.nombre}}</div>
              {{#if this.descripcion}}
              <small class="text-muted">{{this.descripcion}}</small>
              {{/if}}
            </td>
            <td>
              {{#if this.ubicacion}}
              <i class="bi bi-geo-alt me-1 text-primary"></i>{{this.ubicacion}}
              {{else}}
              <span class="text-muted">-</span>
              {{/if}}
            </td>
            <td>
              {{#if this.marca}}
              <div><strong>Marca:</strong> {{this.marca}}</div>
              {{/if}}
              {{#if this.modelo}}
              <div><strong>Modelo:</strong> {{this.modelo}}</div>
              {{/if}}
              {{#unless this.marca}}
              {{#unless this.modelo}}
              <span class="text-muted">-</span>
              {{/unless}}
              {{/unless}}
            </td>
            <td>
              {{#if this.repuestos}}
              {{#if (gt this.repuestos.length 0)}}
              <span class="badge bg-info">{{this.repuestos.length}} repuesto(s)</span>
              {{else}}
              <span class="text-muted">Sin repuestos</span>
              {{/if}}
              {{else}}
              <span class="text-muted">Sin repuestos</span>
              {{/if}}
            </td>
            <td class="text-end">
              <a href="/maquinas/qr/{{this.codigo}}" class="btn btn-sm btn-primary me-1" title="Ver detalles">
                <i class="bi bi-eye"></i>
              </a>
              {{#if (or (eq ../../usuario.rol 'administrador') (eq ../../usuario.rol 'supervisor'))}}
              <a href="/maquinas/editar/{{this._id}}" class="btn btn-sm btn-outline-primary" title="Editar máquina">
                <i class="bi bi-pencil"></i>
              </a>
              {{/if}}
              {{#if (eq ../../usuario.rol 'administrador')}}
              <button class="btn btn-sm btn-outline-danger btn-eliminar-maquina" 
                data-id="{{this._id}}"
                data-codigo="{{this.codigo}}"
                data-nombre="{{this.nombre}}"
                title="Eliminar máquina">
                <i class="bi bi-trash"></i>
              </button>
              {{/if}}
            </td>
          </tr>
          {{/each}}
          {{else}}
          <tr>
            <td colspan="6" class="text-center text-muted py-4">
              No hay máquinas registradas con los filtros seleccionados
            </td>
          </tr>
          {{/if}}
          {{else}}
          <tr>
            <td colspan="6" class="text-center text-muted py-4">
              <i class="bi bi-gear fs-1 d-block mb-3"></i>
              No hay máquinas registradas
              {{#if (or (eq usuario.rol 'administrador') (eq usuario.rol 'supervisor'))}}
              <br>
              <a href="/maquinas/nueva" class="btn btn-primary mt-3">
                <i class="bi bi-plus-circle me-1"></i>Crear primera máquina
              </a>
              {{/if}}
            </td>
          </tr>
          {{/if}}
        </tbody>
      </table>
    </div>
  </div>
</section>

{{#if (gt totalPaginas 1)}}
<nav aria-label="Paginación de máquinas">
  <ul class="pagination justify-content-center">
    {{#if (gt paginaActual 1)}}
    <li class="page-item">
      <a class="page-link" href="/maquinas?pagina={{subtract paginaActual 1}}{{#if busqueda}}&busqueda={{busqueda}}{{/if}}">
        <i class="bi bi-chevron-left"></i>
      </a>
    </li>
    {{else}}
    <li class="page-item disabled">
      <span class="page-link"><i class="bi bi-chevron-left"></i></span>
    </li>
    {{/if}}

    {{#each (generatePaginationPages paginaActual totalPaginas "")}}
    <li class="page-item {{#if this.active}}active{{/if}}">
      <a class="page-link" href="/maquinas?pagina={{this.numero}}{{#if ../busqueda}}&busqueda={{../busqueda}}{{/if}}">{{this.numero}}</a>
    </li>
    {{/each}}

    {{#if (lt paginaActual totalPaginas)}}
    <li class="page-item">
      <a class="page-link" href="/maquinas?pagina={{add paginaActual 1}}{{#if busqueda}}&busqueda={{busqueda}}{{/if}}">
        <i class="bi bi-chevron-right"></i>
      </a>
    </li>
    {{else}}
    <li class="page-item disabled">
      <span class="page-link"><i class="bi bi-chevron-right"></i></span>
    </li>
    {{/if}}
  </ul>
</nav>
{{/if}}

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Búsqueda en tiempo real
  const buscador = document.getElementById('buscador');
  if (buscador) {
    let searchTimeout;
    buscador.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      const busqueda = this.value.trim();
      searchTimeout = setTimeout(() => {
        if (busqueda.length >= 2 || busqueda.length === 0) {
          const url = new URL(window.location.href);
          if (busqueda) {
            url.searchParams.set('busqueda', busqueda);
          } else {
            url.searchParams.delete('busqueda');
          }
          url.searchParams.set('pagina', '1');
          window.location.href = url.toString();
        }
      }, 500);
    });
  }

  // Eliminar máquina
  document.querySelectorAll('.btn-eliminar-maquina').forEach(btn => {
    btn.addEventListener('click', async function() {
      const id = this.dataset.id;
      const codigo = this.dataset.codigo;
      const nombre = this.dataset.nombre;

      if (!confirm(`¿Estás seguro de eliminar la máquina "${nombre}" (${codigo})?`)) {
        return;
      }

      try {
        const response = await fetch(`/maquinas/${id}`, {
          method: 'DELETE',
          credentials: 'same-origin'
        });

        const data = await response.json();

        if (data.success) {
          location.reload();
        } else {
          alert('Error: ' + (data.message || 'No se pudo eliminar la máquina'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error al eliminar la máquina');
      }
    });
  });
});
</script>

